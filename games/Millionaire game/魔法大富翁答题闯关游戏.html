<!doctype html>

<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é­”æ³•å¤§å¯Œç¿é—¯å…³å¤ä¹ æ¸¸æˆ</title>
    <script src="./js/index.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-image: url("./img/111.jpg");
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        overflow-x: hidden;
      }

      .container {
        max-width: 1200px;
        width: 100%;
      }

      header {
        text-align: center;
        margin-bottom: 20px;
        padding: 20px;
      }

      h1 {
        font-size: 2.8rem;
        margin-bottom: 10px;
        text-shadow:
          0 0 15px #6a5af9,
          0 0 25px #6a5af9;
        background: linear-gradient(45deg, #ff6ec4, #7873f5);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: glow 2s ease-in-out infinite alternate;
      }

      .subtitle {
        font-size: 1.2rem;
        color: #a8b2d1;
        margin-bottom: 20px;
      }

      /* æ–°å¢ï¼šæŒ‰é’®å®¹å™¨æ ·å¼ */
      .button-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      .game-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }

      /* æ£‹ç›˜æ ·å¼ */
      .board-container {
        flex: 1;
        min-width: 600px;
        background: rgba(16, 18, 47, 0.7);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 0 30px rgba(106, 90, 249, 0.3);
        border: 1px solid rgba(106, 90, 249, 0.5);
        position: relative;
        overflow: hidden;
      }

      .board {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: repeat(5, 1fr);
        aspect-ratio: 7/5;
        position: relative;
        border: 2px solid rgba(120, 115, 245, 0.3);
        border-radius: 10px;
        background: rgba(12, 14, 43, 0.8);
        box-shadow: 0 0 40px rgba(106, 90, 249, 0.2);
      }

      .cell {
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid rgba(106, 90, 249, 0.3);
        position: relative;
        font-weight: bold;
        font-size: 1.2rem;
        color: #d6d4f7;
        background: rgba(16, 18, 47, 0.6);
        transition: all 0.3s ease;
      }

      .cell:hover {
        background: rgba(106, 90, 249, 0.3);
        box-shadow: 0 0 15px rgba(106, 90, 249, 0.5);
      }

      .cell.corner {
        background: rgba(106, 90, 249, 0.2);
      }

      .cell.start {
        background: rgba(75, 215, 150, 0.2);
      }

      .player {
        position: absolute;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        z-index: 10;
        transition: all 0.5s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
      }

      .player-1 {
        background: linear-gradient(135deg, #ff6ec4, #ff8e7d);
      }

      .player-2 {
        background: linear-gradient(135deg, #6a5af9, #4bcefa);
      }

      .player-3 {
        background: linear-gradient(135deg, #42e695, #3bb2b8);
      }

      .player-4 {
        background: linear-gradient(135deg, #ffd700, #ff8c00);
      }

      /* æ§åˆ¶é¢æ¿æ ·å¼ */
      .control-panel {
        flex: 0 0 300px;
        background: rgba(16, 18, 47, 0.7);
        border-radius: 20px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        box-shadow: 0 0 30px rgba(106, 90, 249, 0.3);
        border: 1px solid rgba(106, 90, 249, 0.5);
      }

      .panel-section {
        background: rgba(12, 14, 43, 0.8);
        border-radius: 15px;
        padding: 15px;
        border: 1px solid rgba(106, 90, 249, 0.3);
      }

      .panel-title {
        font-size: 1.3rem;
        margin-bottom: 15px;
        color: #6a5af9;
        text-align: center;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(106, 90, 249, 0.3);
      }

      .btn {
        background: linear-gradient(45deg, #6a5af9, #4bcefa);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin: 5px 0;
        box-shadow: 0 4px 15px rgba(106, 90, 249, 0.3);
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(106, 90, 249, 0.5);
      }

      .btn:active {
        transform: translateY(1px);
      }

      .back-home-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: linear-gradient(45deg, #ff6ec4, #7873f5);
        color: white;
        border: none;
        padding: 0;
        font-size: 1.5rem;
        border-radius: 50%;
        cursor: pointer;
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 5px 15px rgba(106, 90, 249, 0.4);
        transition: all 0.3s ease;
        z-index: 1000;
        opacity: 0.5;
      }

      .back-home-btn:hover {
        opacity: 1;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(106, 90, 249, 0.6);
      }

      .back-home-btn:active {
        transform: translateY(1px);
      }

      .btn-reset {
        background: linear-gradient(45deg, #ff6ec4, #ff8e7d);
      }

      .btn-import {
        background: linear-gradient(45deg, #42e695, #3bb2b8);
      }

      /* éª°å­æ ·å¼ */
      .dice-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 120px;
        position: relative;
      }

      .dice {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #6a5af9, #4bcefa);
        border-radius: 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2.5rem;
        font-weight: bold;
        color: white;
        cursor: pointer;
        box-shadow: 0 0 20px rgba(106, 90, 249, 0.5);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .dice:before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 0.8) 50%,
          rgba(255, 255, 255, 0) 100%
        );
        transform: rotate(45deg);
        animation: shine 3s infinite linear;
      }

      .dice:hover {
        transform: scale(1.05);
      }

      /* ç©å®¶ä¿¡æ¯ */
      .player-info {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .player-status {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 10px;
        background: rgba(30, 33, 57, 0.5);
      }

      .player-icon {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        margin-right: 10px;
      }

      .player-1-icon {
        background: linear-gradient(135deg, #ff6ec4, #ff8e7d);
      }

      .player-2-icon {
        background: linear-gradient(135deg, #6a5af9, #4bcefa);
      }

      .player-3-icon {
        background: linear-gradient(135deg, #42e695, #3bb2b8);
      }

      .player-4-icon {
        background: linear-gradient(135deg, #ffd700, #ff8c00);
      }

      .current-player {
        background: rgba(106, 90, 249, 0.3);
        box-shadow: 0 0 10px rgba(106, 90, 249, 0.5);
      }

      /* å¼¹çª—æ ·å¼ */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .modal.active {
        opacity: 1;
        pointer-events: all;
      }

      .modal-content {
        background: linear-gradient(135deg, #1a1c3d, #0c0e2b);
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 0 50px rgba(106, 90, 249, 0.5);
        border: 1px solid rgba(106, 90, 249, 0.5);
        transform: scale(0.8);
        opacity: 0;
        transition: all 0.4s ease;
      }

      .modal.active .modal-content {
        transform: scale(1);
        opacity: 1;
      }

      .modal-title {
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: #6a5af9;
      }

      .modal-text {
        font-size: 1.3rem;
        margin: 25px 0;
        color: #d6d4f7;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: rgba(12, 14, 43, 0.6);
        border-radius: 15px;
        border: 1px solid rgba(106, 90, 249, 0.3);
      }

      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
      }

      .modal-btn {
        padding: 12px 30px;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        flex: 1;
        max-width: 180px;
      }

      .btn-withdraw {
        background: linear-gradient(45deg, #ff6ec4, #ff8e7d);
        color: white;
      }

      .btn-continue {
        background: linear-gradient(45deg, #42e695, #3bb2b8);
        color: white;
      }

      .btn-meaning {
        background: linear-gradient(45deg, #ffd700, #ff8c00);
        color: white;
      }

      /* åŠ¨ç”» */
      @keyframes glow {
        0% {
          text-shadow:
            0 0 15px #6a5af9,
            0 0 25px #6a5af9;
        }

        100% {
          text-shadow:
            0 0 25px #ff6ec4,
            0 0 35px #ff6ec4;
        }
      }

      @keyframes shine {
        0% {
          transform: rotate(45deg) translateX(-100%);
        }

        100% {
          transform: rotate(45deg) translateX(100%);
        }
      }

      @keyframes diceRoll {
        0% {
          transform: rotate(0deg) scale(1);
        }

        25% {
          transform: rotate(90deg) scale(1.1);
        }

        50% {
          transform: rotate(180deg) scale(1.2);
        }

        75% {
          transform: rotate(270deg) scale(1.1);
        }

        100% {
          transform: rotate(360deg) scale(1);
        }
      }

      .rolling {
        animation: diceRoll 0.5s ease-in-out;
      }

      /* é­”æ³•æ•ˆæœ */
      .magic-particle {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        pointer-events: none;
        z-index: 5;
      }

      .board:before {
        content: "";
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        background: linear-gradient(45deg, #ff6ec4, #6a5af9, #4bcefa, #42e695);
        z-index: -1;
        filter: blur(20px);
        opacity: 0.3;
        border-radius: 15px;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 950px) {
        .game-container {
          flex-direction: column;
        }

        .board-container {
          min-width: 100%;
        }
      }

      /* æ–°å¢ï¼šæ¸¸æˆè¯´æ˜åŒºæ ·å¼ */
      .game-instructions {
        background: rgba(16, 18, 47, 0.7);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 0 30px rgba(106, 90, 249, 0.3);
        border: 1px solid rgba(106, 90, 249, 0.5);
        margin-top: 20px;
        width: 100%;
      }

      .instructions-title {
        font-size: 1.3rem;
        margin-bottom: 15px;
        color: #6a5af9;
        text-align: center;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(106, 90, 249, 0.3);
      }

      .instructions-text {
        font-size: 1rem;
        color: #d6d4f7;
      }
    </style>
  </head>

  <body>
    <a href="../../index.html" class="back-home-btn">ğŸ </a>
    <div class="container">
      <header>
        <h1>é­”æ³•å¤§å¯Œç¿é—¯å…³å¤ä¹ æ¸¸æˆ</h1>
        <p class="subtitle">å¤šäººPK Â· å¤ä¹ é—¯å…³ Â· è¶£å‘³ç­”é¢˜</p>
        <!-- æ–°å¢ï¼šæŒ‰é’®å®¹å™¨ -->
        <div class="button-container">
          <button class="btn btn-import" id="importBtn">å¯¼å…¥Excelæ–‡ä»¶</button>
          <input
            type="file"
            id="fileInput"
            accept=".xlsx, .xls"
            style="display: none"
          />
          <button class="btn btn-reset" id="resetBtn">é‡ç½®æ¸¸æˆ</button>
        </div>
      </header>

      <div class="game-container">
        <div class="board-container">
          <div class="board" id="gameBoard">
            <!-- æ£‹ç›˜æ ¼å­å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
          <!-- ç©å®¶æ£‹å­å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="control-panel">
          <div class="panel-section">
            <h2 class="panel-title">æ¸¸æˆæ§åˆ¶</h2>
            <button class="btn" id="addPlayerBtn">æ·»åŠ ç©å®¶</button>
            <button class="btn" id="removePlayerBtn">ç§»é™¤ç©å®¶</button>
          </div>

          <div class="panel-section">
            <h2 class="panel-title">æ·éª°å­</h2>
            <div class="dice-container">
              <div class="dice" id="dice">?</div>
            </div>
            <p
              id="diceResult"
              style="text-align: center; margin-top: 10px; color: #d6d4f7"
            >
              ç‚¹å‡»éª°å­å¼€å§‹æ¸¸æˆ
            </p>
          </div>

          <div class="panel-section">
            <h2 class="panel-title">ç©å®¶ä¿¡æ¯</h2>
            <div class="player-info" id="playerInfo">
              <!-- ç©å®¶ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
      </div>
      <!-- æ–°å¢ï¼šæ¸¸æˆè¯´æ˜åŒº -->
      <div class="game-instructions">
        <h2 class="instructions-title">æ¸¸æˆè¯´æ˜</h2>
        <p class="instructions-text">
          1. å¯¼å…¥Excelæ–‡ä»¶ï¼šç¬¬ä¸€åˆ—ä¸ºé¢˜ç›®ï¼Œç¬¬äºŒåˆ—ä¸ºç­”æ¡ˆï¼Œæ— è¡¨å¤´ã€‚<br />
          2. ç‚¹å‡»â€œæ·»åŠ ç©å®¶â€æˆ–â€œç§»é™¤ç©å®¶â€æ§åˆ¶ç©å®¶äººæ•°ã€‚ <br />
          3. ç©å®¶è½®æµæ·éª°å­ï¼Œå‰è¿›ç›¸åº”æ­¥æ•°ï¼Œå½“å‰è¿›åˆ°æŸä¸ªæ ¼å­æ—¶ï¼Œéœ€è¦å›ç­”é—®é¢˜ã€‚
          <br />
          4. å›ç­”æ­£ç¡®ï¼Œè€å¸ˆç‚¹å‡»â€œç»§ç»­æ¸¸æˆâ€æŒ‰é’®ï¼Œè½®åˆ°ä¸‹ä¸€ä½ç©å®¶æŠ•éª°å­ã€‚<br />
          5. å›ç­”é”™è¯¯ï¼Œè€å¸ˆç‚¹å‡»â€œç­”é”™åé€€â€æŒ‰é’®ï¼Œç©å®¶å›åˆ°ä¸Šä¸€ä½ç½®ã€‚<br />
          6.
          å½“ä¸€ä¸ªç©å®¶åˆ°è¾¾ç»ˆç‚¹æˆ–è¶…å‡ºç»ˆç‚¹ä½ç½®ï¼Œåˆ™è¯¥ç©å®¶ç»“æŸæ¸¸æˆã€‚å…¶ä»–ç©å®¶å¯ä»¥ç»§ç»­æ¸¸æˆã€‚
        </p>
      </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal" id="phraseModal">
      <div class="modal-content">
        <h2 class="modal-title">å¤§å¯Œç¿é—¯å…³</h2>
        <div class="modal-text" id="phraseText">æ­£åœ¨åŠ è½½...</div>
        <div class="modal-buttons">
          <button class="modal-btn btn-withdraw" id="withdrawBtn">
            ç­”é”™åé€€
          </button>
          <button class="modal-btn btn-continue" id="continueBtn">
            ç»§ç»­æ¸¸æˆ
          </button>
          <button class="modal-btn btn-meaning" id="meaningBtn">
            æŸ¥çœ‹ç­”æ¡ˆ
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="winModal">
      <div class="modal-content">
        <h2 class="modal-title">æ¸¸æˆç»“æŸ</h2>
        <div class="modal-text" id="winText">æ­å–œç©å®¶åˆ°è¾¾ç»ˆç‚¹ï¼</div>
        <div class="modal-buttons">
          <button
            class="btn btn-reset"
            id="winResetBtn"
            style="margin-top: 20px"
          >
            é‡æ–°å¼€å§‹æ¸¸æˆ
          </button>
          <button class="btn btn-continue" id="continuePlayingBtn">
            ç»§ç»­æ¸¸æˆ
          </button>
        </div>
      </div>
    </div>

    <script>
      // æ¸¸æˆçŠ¶æ€
      const gameState = {
        currentPlayer: 1, // å½“å‰ç©å®¶ç¼–å·
        playerPositions: [], // ç©å®¶ä½ç½®æ•°ç»„
        phrases: [], // å­˜å‚¨çŸ­è¯­çš„æ•°ç»„
        meanings: [], // å­˜å‚¨çŸ­è¯­ä¸­æ–‡é‡Šä¹‰çš„æ•°ç»„
        lastPosition: 0, // è®°å½•ç§»åŠ¨å‰çš„ä½ç½®ï¼ˆç”¨äºæ’¤å›ï¼‰
        gameActive: true,
        playerCount: 2, // ç©å®¶æ•°é‡
        maxPlayers: 4, // æœ€å¤§ç©å®¶æ•°é‡
        minPlayers: 1, // æœ€å°ç©å®¶æ•°é‡
        playersInGame: [], // è®°å½•ä»åœ¨æ¸¸æˆä¸­çš„ç©å®¶
      };

      // DOM å…ƒç´ 
      const elements = {
        gameBoard: document.getElementById("gameBoard"),
        dice: document.getElementById("dice"),
        diceResult: document.getElementById("diceResult"),
        importBtn: document.getElementById("importBtn"),
        resetBtn: document.getElementById("resetBtn"),
        fileInput: document.getElementById("fileInput"),
        phraseModal: document.getElementById("phraseModal"),
        phraseText: document.getElementById("phraseText"),
        withdrawBtn: document.getElementById("withdrawBtn"),
        continueBtn: document.getElementById("continueBtn"),
        winModal: document.getElementById("winModal"),
        winText: document.getElementById("winText"),
        winResetBtn: document.getElementById("winResetBtn"),
        playerInfo: document.getElementById("playerInfo"),
        addPlayerBtn: document.getElementById("addPlayerBtn"),
        removePlayerBtn: document.getElementById("removePlayerBtn"),
        meaningBtn: document.getElementById("meaningBtn"),
        continuePlayingBtn: document.getElementById("continuePlayingBtn"),
      };

      // åˆå§‹åŒ–æ¸¸æˆ
      function initGame() {
        createBoard();
        initPlayers();
        updatePlayerPositions();
        updatePlayerUI();
        gameState.playersInGame = Array.from(
          { length: gameState.playerCount },
          (_, i) => i + 1,
        );

        // æ¸…ç©ºé»˜è®¤é¢˜ç›®
        gameState.phrases = [];
        gameState.meanings = [];

        // äº‹ä»¶ç›‘å¬å™¨
        elements.dice.addEventListener("click", rollDice);
        elements.importBtn.addEventListener("click", () =>
          elements.fileInput.click(),
        );
        elements.fileInput.addEventListener("change", handleFileImport);
        elements.resetBtn.addEventListener("click", resetGame);
        elements.withdrawBtn.addEventListener("click", handleWithdraw);
        elements.continueBtn.addEventListener("click", continueGame);
        elements.winResetBtn.addEventListener("click", resetGame);
        elements.addPlayerBtn.addEventListener("click", addPlayer);
        elements.removePlayerBtn.addEventListener("click", removePlayer);
        elements.meaningBtn.addEventListener("click", showMeaning);
        elements.continuePlayingBtn.addEventListener("click", continuePlaying);
      }

      // åˆ›å»ºæ£‹ç›˜
      function createBoard() {
        // æ¸…ç©ºæ£‹ç›˜
        elements.gameBoard.innerHTML = "";

        // å®šä¹‰æ£‹ç›˜å¸ƒå±€ (5x7 ç½‘æ ¼)
        const gridPositions = [
          // é¡¶éƒ¨è¡Œ (0-6)
          { row: 1, col: 1 },
          { row: 1, col: 2 },
          { row: 1, col: 3 },
          { row: 1, col: 4 },
          { row: 1, col: 5 },
          { row: 1, col: 6 },
          { row: 1, col: 7 },

          // å³ä¾§åˆ— (7-10) - ä»ä¸Šåˆ°ä¸‹
          { row: 2, col: 7 },
          { row: 3, col: 7 },
          { row: 4, col: 7 },
          { row: 5, col: 7 },

          // åº•éƒ¨è¡Œ (11-16) - ä»å³åˆ°å·¦
          { row: 5, col: 6 },
          { row: 5, col: 5 },
          { row: 5, col: 4 },
          { row: 5, col: 3 },
          { row: 5, col: 2 },
          { row: 5, col: 1 },

          // å·¦ä¾§åˆ— (17-19) - ä»ä¸‹åˆ°ä¸Š
          { row: 4, col: 1 },
          { row: 3, col: 1 },
          { row: 2, col: 1 },
        ];

        // åˆ›å»ºæ ¼å­
        for (let i = 0; i < 20; i++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          if (i === 0) {
            cell.textContent = "èµ·ç‚¹";
          } else if (i === 19) {
            cell.textContent = "ç»ˆç‚¹";
          } else {
            cell.textContent = i;
          }

          // ç‰¹æ®Šæ ·å¼
          if (i === 0) cell.classList.add("start");
          if (i === 0 || i === 6 || i === 10 || i === 16)
            cell.classList.add("corner");

          // è®¾ç½®ç½‘æ ¼ä½ç½®
          if (gridPositions[i]) {
            cell.style.gridRow = gridPositions[i].row;
            cell.style.gridColumn = gridPositions[i].col;
          }

          elements.gameBoard.appendChild(cell);
        }
      }

      // åˆå§‹åŒ–ç©å®¶
      function initPlayers() {
        gameState.playerPositions = new Array(gameState.playerCount).fill(0);
        for (let i = 1; i <= gameState.playerCount; i++) {
          createPlayerElement(i);
          createPlayerInfoElement(i);
        }
      }

      // åˆ›å»ºç©å®¶å…ƒç´ 
      function createPlayerElement(playerNumber) {
        const player = document.createElement("div");
        player.className = `player player-${playerNumber}`;
        player.id = `player${playerNumber}`;
        player.textContent = playerNumber;
        elements.gameBoard.appendChild(player);
      }

      // åˆ›å»ºç©å®¶ä¿¡æ¯å…ƒç´ 
      function createPlayerInfoElement(playerNumber) {
        const playerStatus = document.createElement("div");
        playerStatus.className = "player-status";
        playerStatus.id = `player${playerNumber}Status`;

        const playerIcon = document.createElement("div");
        playerIcon.className = `player-icon player-${playerNumber}-icon`;

        const playerText = document.createElement("div");
        playerText.innerHTML = `ç©å®¶ ${playerNumber}: <span id="player${playerNumber}Pos">ä½ç½® 0</span>`;

        playerStatus.appendChild(playerIcon);
        playerStatus.appendChild(playerText);
        elements.playerInfo.appendChild(playerStatus);
      }

      // æ·éª°å­
      function rollDice() {
        if (
          !gameState.gameActive ||
          !gameState.playersInGame.includes(gameState.currentPlayer)
        )
          return;

        // éª°å­åŠ¨ç”»
        elements.dice.textContent = "?";
        elements.dice.classList.add("rolling");
        elements.diceResult.textContent = "æ·éª°å­ä¸­...";

        setTimeout(() => {
          // ç”Ÿæˆéšæœºæ•° (1-6)
          const roll = Math.floor(Math.random() * 6) + 1;
          elements.dice.textContent = roll;
          elements.dice.classList.remove("rolling");
          elements.diceResult.textContent = `ç©å®¶ ${gameState.currentPlayer} æ·å‡ºäº† ${roll}`;

          // ç§»åŠ¨ç©å®¶
          movePlayer(roll);
        }, 800);
      }

      // ç§»åŠ¨ç©å®¶
      function movePlayer(steps) {
        const playerIndex = gameState.currentPlayer - 1;
        gameState.lastPosition = gameState.playerPositions[playerIndex];

        // è®¡ç®—æ–°ä½ç½®
        let newPosition = gameState.playerPositions[playerIndex] + steps;

        // å¦‚æœè¶…è¿‡æ£‹ç›˜æœ€å¤§ä½ç½® (19)
        if (newPosition > 19) {
          newPosition = 19;
        }

        // ä¸€æ ¼ä¸€æ ¼ç§»åŠ¨
        const moveOneStep = () => {
          if (gameState.playerPositions[playerIndex] < newPosition) {
            gameState.playerPositions[playerIndex]++;
            updatePlayerPositions();
            updatePlayerUI();
            setTimeout(moveOneStep, 500); // æ¯500æ¯«ç§’ç§»åŠ¨ä¸€æ ¼
          } else {
            if (newPosition === 19) {
              gameState.gameActive = false;
              setTimeout(() => {
                showWinModal();
              }, 800); // ç­‰å¾…ç§»åŠ¨åŠ¨ç”»å®Œæˆåæ˜¾ç¤ºèƒœåˆ©å¼¹çª—
            } else {
              // æ˜¾ç¤ºçŸ­è¯­å¼¹çª—
              setTimeout(() => {
                showPhrase(newPosition);
              }, 800);
            }
          }
        };

        moveOneStep();
      }

      // æ›´æ–°ç©å®¶ä½ç½®ï¼ˆUIï¼‰
      function updatePlayerPositions() {
        const cells = elements.gameBoard.querySelectorAll(".cell");
        for (let i = 1; i <= gameState.playerCount; i++) {
          const pos = gameState.playerPositions[i - 1];
          const player = document.getElementById(`player${i}`);
          const cell = cells[pos];
          if (cell && player) {
            const rect = cell.getBoundingClientRect();
            const boardRect = elements.gameBoard.getBoundingClientRect();
            const top =
              rect.top -
              boardRect.top +
              rect.height / 2 -
              player.offsetHeight / 2;
            const left =
              rect.left -
              boardRect.left +
              rect.width / 2 -
              player.offsetWidth / 2;
            player.style.top = top + "px";
            player.style.left = left + "px";
          }
        }
      }

      // æ›´æ–°ç©å®¶UI
      function updatePlayerUI() {
        for (let i = 1; i <= gameState.playerCount; i++) {
          const playerPos = document.getElementById(`player${i}Pos`);
          const playerStatus = document.getElementById(`player${i}Status`);
          if (playerPos) {
            playerPos.textContent = `ä½ç½® ${gameState.playerPositions[i - 1]}`;
          }
          if (playerStatus) {
            if (
              i === gameState.currentPlayer &&
              gameState.playersInGame.includes(i)
            ) {
              playerStatus.classList.add("current-player");
            } else {
              playerStatus.classList.remove("current-player");
            }
          }
        }
      }

      // æ˜¾ç¤ºçŸ­è¯­å¼¹çª—
      function showPhrase(position) {
        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        if (position === 19) {
          showWinModal();
          return;
        }

        // æ˜¾ç¤ºçŸ­è¯­
        const phrase = gameState.phrases[position] || `ä½ç½® ${position} çš„çŸ­è¯­`;
        elements.phraseText.textContent = phrase;
        elements.phraseModal.classList.add("active");
      }

      // æ˜¾ç¤ºä¸­æ–‡é‡Šä¹‰
      function showMeaning() {
        const currentPosition =
          gameState.playerPositions[gameState.currentPlayer - 1];
        const meaning = gameState.meanings[currentPosition] || "æš‚æ— é‡Šä¹‰";
        elements.phraseText.textContent += `\nç­”æ¡ˆ: ${meaning}`;
        // ä¸ºäº†ç¡®ä¿æ¢è¡Œç¬¦ç”Ÿæ•ˆï¼Œå°†æ–‡æœ¬å†…å®¹è½¬æ¢ä¸º HTML å¹¶ä½¿ç”¨ <br> æ ‡ç­¾
        elements.phraseText.innerHTML = elements.phraseText.textContent.replace(
          /\n/g,
          "<br>",
        );
      }

      // å¤„ç†æ’¤å›
      function handleWithdraw() {
        const playerIndex = gameState.currentPlayer - 1;
        gameState.playerPositions[playerIndex] = gameState.lastPosition;

        // æ›´æ–°UI
        updatePlayerPositions();

        // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç©å®¶
        nextPlayer();
        elements.phraseModal.classList.remove("active");
      }

      // ç»§ç»­æ¸¸æˆ
      function continueGame() {
        nextPlayer();
        elements.phraseModal.classList.remove("active");
      }

      // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç©å®¶
      function nextPlayer() {
        let nextIndex =
          gameState.playersInGame.indexOf(gameState.currentPlayer) + 1;
        if (nextIndex >= gameState.playersInGame.length) {
          nextIndex = 0;
        }
        gameState.currentPlayer = gameState.playersInGame[nextIndex];
        updatePlayerUI();
      }

      // å¯¼å…¥Excelæ–‡ä»¶
      function handleFileImport(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });

            // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];

            // è½¬æ¢ä¸ºJSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // æå–çŸ­è¯­å’Œé‡Šä¹‰
            gameState.phrases = [];
            gameState.meanings = [];
            jsonData.forEach((row) => {
              if (row[0]) {
                gameState.phrases.push(row[0]);
                gameState.meanings.push(row[1] || "æš‚æ— é‡Šä¹‰");
              }
            });

            // å¦‚æœå¯¼å…¥çš„çŸ­è¯­ä¸è¶³ï¼Œä¸è¿›è¡Œè¡¥å……
            alert(`æˆåŠŸå¯¼å…¥ ${gameState.phrases.length} æ¡ï¼`);
          } catch (error) {
            alert(`å¯¼å…¥æ–‡ä»¶å¤±è´¥: ${error.message}`);
          }
        };
        reader.onerror = function () {
          alert("è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
        };
        reader.readAsArrayBuffer(file);
      }

      // é‡ç½®æ¸¸æˆ
      function resetGame() {
        gameState.currentPlayer = 1;
        gameState.playerPositions = new Array(gameState.playerCount).fill(0);
        gameState.lastPosition = 0;
        gameState.gameActive = true;
        gameState.playersInGame = Array.from(
          { length: gameState.playerCount },
          (_, i) => i + 1,
        );

        // æ›´æ–°UI
        updatePlayerPositions();
        updatePlayerUI();

        // å…³é—­å¼¹çª—
        elements.phraseModal.classList.remove("active");
        elements.winModal.classList.remove("active");

        elements.dice.textContent = "?";
        elements.diceResult.textContent = "ç‚¹å‡»éª°å­å¼€å§‹æ¸¸æˆ";
      }

      // æ·»åŠ ç©å®¶
      function addPlayer() {
        if (gameState.playerCount < gameState.maxPlayers) {
          gameState.playerCount++;
          gameState.playerPositions.push(0);
          gameState.playersInGame.push(gameState.playerCount);
          createPlayerElement(gameState.playerCount);
          createPlayerInfoElement(gameState.playerCount);
          updatePlayerPositions();
          updatePlayerUI();
        } else {
          alert("æœ€å¤šæ”¯æŒ4åç©å®¶ï¼");
        }
      }

      // ç§»é™¤ç©å®¶
      function removePlayer() {
        if (gameState.playerCount > gameState.minPlayers) {
          const lastPlayerNumber = gameState.playerCount;
          const playerElement = document.getElementById(
            `player${lastPlayerNumber}`,
          );
          const playerStatusElement = document.getElementById(
            `player${lastPlayerNumber}Status`,
          );
          if (playerElement) {
            playerElement.remove();
          }
          if (playerStatusElement) {
            playerStatusElement.remove();
          }
          gameState.playerCount--;
          gameState.playerPositions.pop();
          const index = gameState.playersInGame.indexOf(lastPlayerNumber);
          if (index !== -1) {
            gameState.playersInGame.splice(index, 1);
          }
          if (gameState.currentPlayer > gameState.playerCount) {
            gameState.currentPlayer = 1;
          }
          updatePlayerPositions();
          updatePlayerUI();
        } else {
          alert("è‡³å°‘éœ€è¦1åç©å®¶ï¼");
        }
      }

      // æ˜¾ç¤ºè·èƒœå¼¹çª—
      function showWinModal() {
        elements.winText.textContent = `æ­å–œç©å®¶ ${gameState.currentPlayer} åˆ°è¾¾ç»ˆç‚¹ï¼`;
        elements.winModal.classList.add("active");
      }

      // ç»§ç»­æ¸¸æˆï¼ˆè·èƒœç©å®¶é€€å‡ºï¼‰
      function continuePlaying() {
        const winnerIndex = gameState.playersInGame.indexOf(
          gameState.currentPlayer,
        );
        if (winnerIndex !== -1) {
          gameState.playersInGame.splice(winnerIndex, 1);
        }

        if (gameState.playersInGame.length === 0) {
          alert("æ²¡æœ‰ç©å®¶ç»§ç»­æ¸¸æˆï¼Œæ¸¸æˆç»“æŸï¼");
          resetGame();
        } else {
          gameState.gameActive = true;
          gameState.currentPlayer = gameState.playersInGame[0];
          updatePlayerUI();
          elements.winModal.classList.remove("active");
        }
      }

      // åˆå§‹åŒ–æ¸¸æˆ
      window.addEventListener("DOMContentLoaded", initGame);
    </script>
  </body>
</html>

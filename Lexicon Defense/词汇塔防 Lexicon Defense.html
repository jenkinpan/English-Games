<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>词汇塔防 · Lexicon Defense</title>
    <style>
      :root {
        color-scheme: light dark;
        /* === 修改说明 ===
               1. "Times New Roman": 优先用于英文、数字和标点。
               2. "SimSun", "宋体": 用于中文字符。
               3. serif: 衬线体作为通用后备。
            */
        font-family: "Times New Roman", "SimSun", "宋体", serif;

        --bg: #060b23;
        --panel: rgba(12, 21, 54, 0.95);
        --accent: #7cdfff;
        --accent-strong: #57c4ff;
        --alert: #ff7d7d;
        --success: #4caf50;
        --text: #f4f7ff;
        --slot-bg: rgba(255, 255, 255, 0.08);
      }

      * {
        box-sizing: border-box;
        user-select: none;
      }

      /* 确保 input 和 button 继承上面的字体设置 */
      input,
      button,
      textarea {
        font-family: inherit;
      }

      /* --- 全局滚动条美化 --- */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(124, 223, 255, 0.25);
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: content-box;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(124, 223, 255, 0.5);
        border: 0;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px 16px 48px;
        background: radial-gradient(circle at top, #172552, #050812 65%);
        color: var(--text);
        /* 默认允许滚动，但在弹窗打开时会被 JS 修改为 hidden */
        overflow-x: hidden;
      }

      h1 {
        margin: 0 0 4px;
        font-size: clamp(1.8rem, 4vw, 2.8rem);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      h2 {
        margin: 8px 0 24px;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.75);
      }

      .game-shell {
        width: min(900px, 95vw);
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 24px;
        padding: 28px;
        box-shadow: 0 30px 60px rgba(3, 5, 20, 0.6);
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
        transform: translate3d(0, 0, 0);
      }

      .shake {
        animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
      }

      @keyframes shake {
        10%,
        90% {
          transform: translate3d(-1px, 0, 0);
        }

        20%,
        80% {
          transform: translate3d(2px, 0, 0);
        }

        30%,
        50%,
        70% {
          transform: translate3d(-4px, 0, 0);
        }

        40%,
        60% {
          transform: translate3d(4px, 0, 0);
        }
      }

      .hud {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-between;
        font-size: 0.95rem;
        align-items: center;
      }

      .hud span {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 999px;
        padding: 8px 16px;
        letter-spacing: 0.05em;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      #timer {
        display: inline-block;
        transition: color 0.2s;
        font-variant-numeric: tabular-nums;
      }

      #shield {
        display: inline-block;
        transition: color 0.2s;
      }

      .timer-warning {
        color: var(--alert) !important;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(255, 125, 125, 0.5);
        animation: panic-pulse 1s infinite ease-in-out;
      }

      .shield-damage {
        color: var(--alert) !important;
        text-shadow: 0 0 15px var(--alert);
        animation: shield-pulse 0.5s ease-out;
      }

      @keyframes shield-pulse {
        0% {
          transform: scale(1);
        }

        30% {
          transform: scale(1.8);
        }

        100% {
          transform: scale(1);
        }
      }

      @keyframes panic-pulse {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.4);
        }

        100% {
          transform: scale(1);
        }
      }

      .battlefield {
        border: 2px dashed rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        padding: 32px 20px;
        text-align: center;
        min-height: 220px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 18px;
        position: relative;
        overflow: hidden;
      }

      .enemy {
        display: inline-flex;
        padding: 14px 26px;
        border-radius: 40px;
        background: rgba(255, 93, 145, 0.2);
        border: 2px solid rgba(255, 93, 145, 0.6);
        font-size: 1.4rem;
        letter-spacing: 0.08em;
        animation: drift 6s ease-in-out infinite alternate;
      }

      @keyframes drift {
        from {
          transform: translateY(-8px);
        }

        to {
          transform: translateY(10px);
        }
      }

      .hint {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.5);
        min-height: 1.5em;
        transition:
          color 0.3s,
          text-shadow 0.3s;
      }

      .hint-active {
        color: var(--accent);
        text-shadow: 0 0 8px rgba(124, 223, 255, 0.4);
      }

      .interaction-zone {
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 10px 0;
      }

      .slots-container {
        display: flex;
        justify-content: center;
        gap: 8px;
        min-height: 60px;
        flex-wrap: wrap;
      }

      .letter-slot {
        width: 48px;
        height: 48px;
        border-bottom: 3px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--accent);
        background: var(--slot-bg);
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        transition: all 0.2s;
      }

      .letter-slot:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .letter-slot.empty {
        color: transparent;
      }

      .pool-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        min-height: 50px;
      }

      .letter-tile {
        width: 44px;
        height: 44px;
        border-radius: 8px;
        background: linear-gradient(135deg, #2a3b68, #16224a);
        border: 1px solid rgba(124, 223, 255, 0.3);
        color: var(--text);
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition:
          transform 0.1s,
          background 0.2s;
      }

      .letter-tile:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, #384c81, #1f2e61);
        border-color: var(--accent);
      }

      .letter-tile:active {
        transform: scale(0.95);
      }

      .action-buttons {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 8px;
      }

      button {
        padding: 14px 22px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(
          120deg,
          var(--accent),
          var(--accent-strong)
        );
        color: #041126;
        font-weight: 600;
        letter-spacing: 0.05em;
        cursor: pointer;
        transition:
          transform 120ms ease,
          filter 120ms ease;
      }

      button:active {
        transform: scale(0.96);
      }

      button:disabled {
        filter: grayscale(1);
        cursor: not-allowed;
        opacity: 0.6;
      }

      .controls {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .controls-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .controls button.secondary,
      .action-buttons button.secondary {
        background: transparent;
        color: var(--accent);
        border: 1px solid rgba(124, 223, 255, 0.5);
      }

      .controls button.btn-quit {
        color: var(--alert);
        border-color: rgba(255, 125, 125, 0.5);
      }

      .controls button.btn-quit:hover:not(:disabled) {
        background: rgba(255, 125, 125, 0.1);
      }

      .log {
        min-height: 40px;
        font-size: 0.95rem;
        color: var(--accent);
        text-align: center;
      }

      .log.error {
        color: var(--alert);
      }

      .vfx-float {
        position: fixed;
        font-weight: 800;
        font-size: 1.5rem;
        pointer-events: none;
        z-index: 9999;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .vfx-up {
        color: var(--success);
        animation: floatUp 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      }

      .vfx-down {
        color: var(--alert);
        animation: floatDown 1.2s ease-in forwards;
      }

      @keyframes floatUp {
        0% {
          transform: translateY(0) scale(0.5);
          opacity: 0;
        }

        20% {
          transform: translateY(-10px) scale(1.2);
          opacity: 1;
        }

        100% {
          transform: translateY(-50px) scale(1);
          opacity: 0;
        }
      }

      @keyframes floatDown {
        0% {
          transform: translateY(0) scale(1);
          opacity: 1;
        }

        30% {
          transform: translateY(10px) scale(1.2);
          opacity: 1;
        }

        100% {
          transform: translateY(60px) scale(0.8);
          opacity: 0;
        }
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }

      .modal-overlay.active {
        display: flex;
      }

      .editor-window {
        width: min(800px, 90vw);
        height: min(600px, 90vh);
        background: #0c1536;
        border: 1px solid var(--accent);
        border-radius: 16px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .editor-header {
        display: flex;
        justify-content: space-between;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .word-list {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding-right: 4px;

        /* --- 关键修复：防止滚动穿透 --- */
        overscroll-behavior: contain;
      }

      .word-item {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .word-item input {
        padding: 12px 14px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.08);
        color: white;
        border: 1px solid transparent;
        height: 44px;
      }

      .word-item input.w-correct {
        flex: 2;
      }

      .word-item input.w-clue {
        flex: 3;
      }

      .btn-icon {
        width: 44px;
        height: 44px;
        background: rgba(255, 125, 125, 0.15);
        color: var(--alert);
        border-radius: 8px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        line-height: 1;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .btn-icon:hover {
        background: var(--alert);
        color: white;
        transform: scale(1.05);
      }

      .editor-footer {
        display: flex;
        justify-content: space-between;
        padding-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>

  <body>
    <h1>Lexicon Defense</h1>
    <h2>纠正来袭的错词，守护词汇城墙！</h2>

    <section id="gameShell" class="game-shell" role="main">
      <div class="hud">
        <span>波次：<strong id="wave">0/0</strong></span>
        <span>分数：<strong id="score">0</strong></span>
        <span>护盾：<strong id="shield">3</strong></span>
        <span>倒计时：<strong id="timer">—</strong></span>
      </div>

      <div class="battlefield" aria-live="polite">
        <div id="enemyWord" class="enemy">点击开始以生成敌人</div>
        <div id="hint" class="hint">
          每波会出现一个自动生成的拼写错误，点击下方字母修复它。
        </div>
      </div>

      <div class="interaction-zone">
        <div id="answerSlots" class="slots-container"></div>
        <div id="letterPool" class="pool-container"></div>
        <div class="action-buttons">
          <button id="resetInput" class="secondary" disabled>重置</button>
          <button id="fire" disabled>发射</button>
        </div>
      </div>

      <div id="log" class="log"></div>

      <div class="controls">
        <div class="controls-group">
          <button id="start">开始新一局</button>
          <button id="stop" class="secondary btn-quit" disabled>
            结束游戏
          </button>
          <button id="editBtn" class="secondary">编辑词库</button>
        </div>
        <button id="skip" class="secondary" disabled>跳过此波 (-1 分)</button>
      </div>
    </section>

    <div id="editorModal" class="modal-overlay">
      <div class="editor-window">
        <div class="editor-header">
          <h3>词库编辑器</h3>
          <span style="font-size: 0.85rem; opacity: 0.7; color: var(--accent)"
            >系统自动生成错词</span
          >
        </div>
        <div id="editorList" class="word-list"></div>
        <div class="editor-footer">
          <button
            id="addWordBtn"
            class="secondary"
            style="border-color: var(--text); color: var(--text)"
          >
            + 添加单词
          </button>
          <div style="display: flex; gap: 10px">
            <button id="closeEditorBtn" class="secondary">取消</button>
            <button id="saveEditorBtn">保存并关闭</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===========================
      // 1. 音效系统
      // ===========================
      const SoundFX = (() => {
        let ctx = null;
        const init = () => {
          if (!ctx)
            ctx = new (window.AudioContext || window.webkitAudioContext)();
        };
        const playTone = (freq, type, duration, vol = 0.1) => {
          if (!ctx) init();
          if (ctx.state === "suspended") ctx.resume();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, ctx.currentTime);
          gain.gain.setValueAtTime(vol, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.01,
            ctx.currentTime + duration,
          );
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start();
          osc.stop(ctx.currentTime + duration);
        };
        return {
          shoot: () => {
            playTone(600, "square", 0.1, 0.05);
            setTimeout(() => playTone(800, "square", 0.1, 0.05), 50);
          },
          hit: () => {
            playTone(440, "sine", 0.1);
            setTimeout(() => playTone(880, "sine", 0.2), 100);
          },
          error: () => {
            playTone(150, "sawtooth", 0.3, 0.15);
            setTimeout(() => playTone(100, "sawtooth", 0.3, 0.15), 150);
          },
          click: () => {
            playTone(1200, "sine", 0.05, 0.03);
          },
          win: () => {
            [440, 554, 659, 880].forEach((f, i) =>
              setTimeout(() => playTone(f, "square", 0.3, 0.05), i * 100),
            );
          },
          loss: () => {
            [300, 250, 200, 150].forEach((f, i) =>
              setTimeout(() => playTone(f, "sawtooth", 0.4, 0.1), i * 150),
            );
          },
        };
      })();

      // ===========================
      // 2. 特效系统
      // ===========================
      const VFX = {
        floatText: (targetId, text, type) => {
          const target = document.getElementById(targetId);
          if (!target) return;
          const rect = target.getBoundingClientRect();
          const el = document.createElement("div");
          el.textContent = text;
          el.className = `vfx-float ${type === "gain" ? "vfx-up" : "vfx-down"}`;
          el.style.left = `${rect.left + rect.width / 2}px`;
          el.style.top = `${rect.top}px`;
          document.body.appendChild(el);
          setTimeout(() => el.remove(), 1200);
        },
        shakeScreen: () => {
          const shell = document.getElementById("gameShell");
          shell.classList.remove("shake");
          void shell.offsetWidth;
          shell.classList.add("shake");
        },
        pulseElement: (targetId, className) => {
          const el = document.getElementById(targetId);
          if (!el) return;
          el.classList.remove(className);
          void el.offsetWidth;
          el.classList.add(className);
          setTimeout(() => el.classList.remove(className), 500);
        },
      };

      // ===========================
      // 3. 游戏逻辑
      // ===========================
      const defaultVocabulary = [
        { correct: "floor", clue: "n. 地板" },
        { correct: "window", clue: "n. 窗户" },
        { correct: "chair", clue: "n. 椅子" },
        { correct: "table", clue: "n. 桌子" },
        { correct: "sofa", clue: "n. 沙发" },
        { correct: "door", clue: "n. 门" },
        { correct: "phone", clue: "n. 电话" },
        { correct: "clean", clue: "v. 打扫" },
        { correct: "please", clue: "int. 请" },
        { correct: "television", clue: "n. 电视" },
      ];

      let isGameActive = false;
      let activeVocabulary = [];
      let queue = [];
      let current = null;
      let score = 0;
      let shield = 3;
      let wave = 0;
      let timer = 0;
      let timerId = null;
      const ANSWER_TIME = 18;

      let currentSlots = [];
      let currentPool = [];

      const refs = {
        enemy: document.getElementById("enemyWord"),
        hint: document.getElementById("hint"),
        log: document.getElementById("log"),
        answerSlots: document.getElementById("answerSlots"),
        letterPool: document.getElementById("letterPool"),
        resetInput: document.getElementById("resetInput"),
        fire: document.getElementById("fire"),
        start: document.getElementById("start"),
        stop: document.getElementById("stop"),
        skip: document.getElementById("skip"),
        wave: document.getElementById("wave"),
        score: document.getElementById("score"),
        shield: document.getElementById("shield"),
        timer: document.getElementById("timer"),
        editBtn: document.getElementById("editBtn"),
        editorModal: document.getElementById("editorModal"),
        editorList: document.getElementById("editorList"),
        addWordBtn: document.getElementById("addWordBtn"),
        saveEditorBtn: document.getElementById("saveEditorBtn"),
        closeEditorBtn: document.getElementById("closeEditorBtn"),
      };

      const scrambleWord = (word) => {
        if (word.length <= 1) return word;
        const arr = word.split("");
        let limit = 10;
        while (limit > 0) {
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          const result = arr.join("");
          if (result.toLowerCase() !== word.toLowerCase()) return result;
          limit--;
        }
        return arr.join("");
      };

      const simpleShuffle = (arr) => {
        const newArr = [...arr];
        for (let i = newArr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
        }
        return newArr;
      };

      const loadData = () => {
        const stored = localStorage.getItem("lexicon_vocab");
        if (stored) {
          try {
            return JSON.parse(stored);
          } catch (e) {}
        }
        return JSON.parse(JSON.stringify(defaultVocabulary));
      };
      const saveData = (data) =>
        localStorage.setItem("lexicon_vocab", JSON.stringify(data));

      const initGame = () => {
        activeVocabulary = loadData();
        refs.editBtn.disabled = false;
        refs.stop.disabled = true;
      };

      const resetState = () => {
        SoundFX.shoot();
        activeVocabulary = loadData();
        if (activeVocabulary.length === 0) {
          alert("词库为空！请先添加单词。");
          openEditor();
          return;
        }

        const preparedList = activeVocabulary.map((item) => ({
          ...item,
          miss: scrambleWord(item.correct),
        }));

        queue = simpleShuffle(preparedList);
        score = 0;
        shield = 3;
        wave = 0;
        current = null;
        isGameActive = true;

        refs.fire.disabled = true;
        refs.resetInput.disabled = true;
        refs.editBtn.disabled = true;
        refs.stop.disabled = false;

        refs.log.textContent = "准备作战！";
        refs.log.classList.remove("error");

        refs.hint.classList.remove("hint-active");

        updateHUD();
        spawnEnemy();
      };

      const updateHUD = () => {
        refs.wave.textContent = `${wave}/${activeVocabulary.length}`;
        refs.score.textContent = score;
        refs.shield.textContent = shield;
        refs.timer.textContent = timer > 0 ? `${timer}s` : "—";

        if (isGameActive) {
          if (timer <= 5 && timer > 0) {
            refs.timer.classList.add("timer-warning");
          } else {
            refs.timer.classList.remove("timer-warning");
          }

          if (current) {
            if (timer <= 10) {
              refs.hint.textContent = `提示：${current.clue}`;
              refs.hint.classList.add("hint-active");
            } else {
              const waitTime = timer - 10;
              refs.hint.textContent = `提示：线索分析中... (${waitTime}s)`;
              refs.hint.classList.remove("hint-active");
            }
          }

          if (current && score > 0) {
            refs.skip.disabled = false;
          } else {
            refs.skip.disabled = true;
          }
        }
      };

      const spawnEnemy = () => {
        if (timerId) window.clearInterval(timerId);
        if (!queue.length) {
          victory();
          return;
        }

        current = queue.shift();
        wave++;
        refs.enemy.textContent = current.miss;

        refs.log.textContent = "点击字母进行排序...";
        refs.log.classList.remove("error");

        initInputZone(current.correct);

        timer = ANSWER_TIME;
        timerId = window.setInterval(() => {
          timer--;
          if (timer <= 0) {
            window.clearInterval(timerId);
            damage("倒计时耗尽，护盾 -1。");
          }
          updateHUD();
        }, 1000);
        updateHUD();
      };

      const initInputZone = (correctWord) => {
        currentSlots = new Array(correctWord.length).fill(null);
        currentPool = simpleShuffle(correctWord.split(""));
        renderInputUI();
      };

      const renderInputUI = () => {
        refs.answerSlots.innerHTML = "";
        refs.letterPool.innerHTML = "";

        currentSlots.forEach((char, index) => {
          const slot = document.createElement("div");
          slot.className = "letter-slot";
          if (char) {
            slot.textContent = char;
            slot.onclick = () => returnLetterToPool(index);
          } else {
            slot.classList.add("empty");
          }
          refs.answerSlots.appendChild(slot);
        });

        currentPool.forEach((char, index) => {
          const tile = document.createElement("div");
          tile.className = "letter-tile";
          tile.textContent = char;
          tile.onclick = () => moveLetterToSlot(index);
          refs.letterPool.appendChild(tile);
        });

        const isFull = currentSlots.every((c) => c !== null);
        refs.fire.disabled = !isGameActive || !isFull;

        const hasInput = currentSlots.some((c) => c !== null);
        refs.resetInput.disabled = !isGameActive || !hasInput;
      };

      const moveLetterToSlot = (poolIndex) => {
        if (!isGameActive) return;
        const emptySlotIndex = currentSlots.findIndex((c) => c === null);
        if (emptySlotIndex === -1) return;

        const char = currentPool[poolIndex];
        currentSlots[emptySlotIndex] = char;
        currentPool.splice(poolIndex, 1);

        SoundFX.click();
        renderInputUI();
      };

      const returnLetterToPool = (slotIndex) => {
        if (!isGameActive) return;
        const char = currentSlots[slotIndex];
        if (!char) return;

        currentSlots[slotIndex] = null;
        currentPool.push(char);

        SoundFX.click();
        renderInputUI();
      };

      const resetInputAll = () => {
        if (!isGameActive || !current) return;
        currentSlots.forEach((char) => {
          if (char) currentPool.push(char);
        });
        currentSlots.fill(null);
        renderInputUI();
      };

      const checkAnswer = () => {
        if (!isGameActive || !current) return;

        const attempt = currentSlots.join("").toLowerCase();

        if (attempt === current.correct.toLowerCase()) {
          score += 2;
          SoundFX.hit();
          VFX.floatText("score", "+2", "gain");
          updateHUD();
          refs.log.textContent = `命中！正确拼写：${current.correct}`;
          refs.log.classList.remove("error");
          spawnEnemy();
        } else {
          shield--;
          SoundFX.error();
          VFX.shakeScreen();
          VFX.floatText("shield", "-1", "loss");
          VFX.pulseElement("shield", "shield-damage");

          refs.log.textContent = "拼写错误，护盾 -1！";
          refs.log.classList.add("error");
          if (shield <= 0) gameOver();
          updateHUD();
        }
      };

      const damage = (msg) => {
        shield--;
        SoundFX.error();
        VFX.shakeScreen();
        VFX.floatText("shield", "-1", "loss");
        VFX.pulseElement("shield", "shield-damage");

        refs.log.textContent = msg;
        refs.log.classList.add("error");
        if (shield <= 0) {
          gameOver();
        } else {
          spawnEnemy();
        }
        updateHUD();
      };

      const skipWave = () => {
        if (!isGameActive || !current || score <= 0) return;
        score = Math.max(0, score - 1);
        SoundFX.shoot();
        VFX.floatText("score", "-1", "loss");
        refs.log.textContent = `跳过，答案是：${current.correct}`;
        refs.log.classList.remove("error");
        spawnEnemy();
        updateHUD();
      };

      const quitGame = () => {
        if (isGameActive) endGame("游戏已手动结束。");
      };
      const victory = () => {
        SoundFX.win();
        endGame("恭喜！所有错词已被纠正。");
      };
      const gameOver = () => {
        SoundFX.loss();
        endGame(`护盾耗尽！答案应为：${current ? current.correct : "未知"}`);
      };

      const endGame = (msg) => {
        isGameActive = false;
        current = null;
        refs.enemy.textContent =
          shield > 0 && queue.length === 0 ? "胜利！" : "结束";

        refs.hint.textContent = msg;
        refs.hint.classList.add("hint-active");

        refs.fire.disabled = true;
        refs.resetInput.disabled = true;
        refs.editBtn.disabled = false;
        refs.stop.disabled = true;
        updateHUD();
        refs.log.textContent = `最终得分：${score}`;
        if (timerId) window.clearInterval(timerId);
        refs.timer.textContent = "—";
        refs.timer.classList.remove("timer-warning");
      };

      const createInputRow = (word = "", clue = "") => {
        const div = document.createElement("div");
        div.className = "word-item";
        div.innerHTML = `
                <input type="text" class="w-correct" placeholder="正确单词" value="${word}">
                <input type="text" class="w-clue" placeholder="线索" value="${clue}">
                <button class="btn-icon" onclick="this.parentElement.remove()">×</button>
            `;
        return div;
      };

      // --- 关键修复：JS 锁定背景滚动 ---
      const openEditor = () => {
        const data = loadData();
        refs.editorList.innerHTML = "";
        data.forEach((item) => {
          refs.editorList.appendChild(createInputRow(item.correct, item.clue));
        });
        if (data.length === 0) refs.editorList.appendChild(createInputRow());

        document.body.style.overflow = "hidden"; // 锁定背景
        refs.editorModal.classList.add("active");
      };

      const closeEditor = () => {
        document.body.style.overflow = ""; // 解锁背景
        refs.editorModal.classList.remove("active");
      };

      const saveAndCloseEditor = () => {
        const rows = refs.editorList.querySelectorAll(".word-item");
        const newData = [];
        rows.forEach((row) => {
          const correct = row.querySelector(".w-correct").value.trim();
          const clue = row.querySelector(".w-clue").value.trim();
          if (correct && clue) newData.push({ correct, clue });
        });
        if (newData.length === 0 && !confirm("词库为空，确定要保存吗？"))
          return;
        saveData(newData);
        activeVocabulary = newData;
        closeEditor(); // 使用封装的关闭函数
        refs.log.textContent = "词库已更新，点击“开始新一局”生效。";
      };

      refs.start.addEventListener("click", resetState);
      refs.stop.addEventListener("click", quitGame);
      refs.fire.addEventListener("click", checkAnswer);
      refs.resetInput.addEventListener("click", resetInputAll);
      refs.skip.addEventListener("click", skipWave);

      refs.editBtn.addEventListener("click", openEditor);
      refs.closeEditorBtn.addEventListener("click", closeEditor);
      refs.addWordBtn.addEventListener("click", () => {
        refs.editorList.appendChild(createInputRow());
        refs.editorList.scrollTop = refs.editorList.scrollHeight;
      });
      refs.saveEditorBtn.addEventListener("click", saveAndCloseEditor);

      initGame();
    </script>
  </body>
</html>

